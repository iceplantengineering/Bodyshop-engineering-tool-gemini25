# Bodyshop Engineering Tool (仮)

3Dモデルと関連データ（溶接点、ロケーター、ピンなど）を視覚化し、編集するためのWebアプリケーションです。

## 主な機能 (開発中含む)

-   STL/OBJ形式の3Dモデルの読み込みと表示
-   CSV形式でのWeld Point, Locator, Pinデータの読み込み、表示、編集
-   オブジェクトの選択、移動、回転
-   プロパティ編集パネル
-   工程（Process）によるデータフィルタリング
-   カメラ制御（視点変更、クリッピング調整）
-   データの追加・削除
-   フィルタリングされたデータのエクスポート
-   **断面画像生成機能 (PythonバックエンドAPI連携)**

## 断面画像生成機能 (WIP)

本プロジェクトには、指定されたOBJモデルとLOCATOR情報（位置、回転）に基づき、LOCATORの位置でモデルの断面（または断面に近いビュー）の画像を生成する機能が含まれています。
この機能は、PythonバックエンドAPIとフロントエンドの連携によって実現されています。

### バックエンド (Python API)

-   **フレームワーク**: Flask
-   **主要ライブラリ**:
    -   `PyVista` (及び `VTK`): 3Dメッシュの読み込み、スライス処理、画像生成
    -   `Flask-CORS`: フロントエンドからのクロスオリジンリクエストを許可
    -   `Pillow`: (PyVistaが内部で使用、または画像処理の補助)
    -   `numpy`: 数値計算
-   **実行ファイル**:
    -   `app.py`: Flask APIサーバーのメインファイル。`/slice` エンドポイントを提供。
    -   `slice_obj.py`: PyVistaを使った断面画像生成ロジックを実装。
-   **APIエンドポイント**:
    -   `POST /slice`
        -   リクエストボディ (JSON):
            ```json
            {
              "obj_file_path": "data/your_model.obj", // プロジェクトルートからの相対パスまたは絶対パス
              "locators": [
                {
                  "id": "LOC001",
                  "x": 10.0, "y": 20.0, "z": 30.0,
                  "rx": 0, "ry": 0, "rz": 0 
                }
                // 他のLOCATORデータ...
              ]
            }
            ```
        -   レスポンス (JSON):
            -   成功時: 処理結果のメッセージ、生成された画像のパスなど
            -   失敗時: エラーメッセージ

### セットアップと実行

#### 1. Python環境のセットアップ

-   Python 3.10 の使用を推奨します。
-   プロジェクトルートにPython 3.10の仮想環境を作成します。

    ```bash
    python -m venv .venv310
    ```
-   仮想環境をアクティベートします。
    -   Windows (PowerShell): `.\.venv310\Scripts\activate`
    -   macOS/Linux: `source .venv310/bin/activate`
-   必要なPythonライブラリをインストールします。

    ```bash
    pip install Flask flask-cors pyvista Pillow numpy
    # open3d は削除しました。
    ```

#### 2. APIサーバーの起動

-   仮想環境がアクティベートされたターミナルで、プロジェクトルートから以下を実行します。

    ```bash
    python app.py
    ```
-   APIサーバーが `http://localhost:5000` で起動します。

#### 3. フロントエンド開発サーバーの起動

-   別のターミナルを開き、プロジェクトルートでフロントエンドの開発サーバーを起動します。

    ```bash
    npm install
    npm run dev 
    # または yarn dev など、package.json の scripts に定義されたコマンド
    ```
-   開発サーバーが `http://localhost:5173` (または別のポート) で起動します。

#### 4. 機能の利用

-   ブラウザでフロントエンドのURL (例: `http://localhost:5173`) を開きます。
-   OBJモデルとLOCATORデータをロードします。
-   右側のコントロールパネルでLOCATORを選択し、「選択Locator断面生成」ボタンをクリックすると、APIが呼び出され、断面画像が `data/generated_slices/` ディレクトリに保存されます。

### 現在の状況と課題

-   PyVistaを使用して断面（輪郭線）を生成しています。
-   LOCATOR中心の半径200mmの範囲のビュー表示については、カメラの平行投影スケールで調整を試みています。
-   「真の断面図」としての品質（例えば、断面の塗りつぶし、より精密な範囲クリッピングなど）については、さらなる改善の余地があります。
-   複雑なOBJファイルや、サポート外のジオメトリを含むOBJファイルでは、メッシュの読み込みやスライス処理に失敗する場合があります。

---